<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>项目管理</title>
    <th:block th:replace="~{template::commonJs}"></th:block>
</head>
<body>
<div id="app">
    <n-config-provider :locale="zhCN" :date-locale="dateZhCN">
        <!--按钮-->
        <n-flex justify="space-between">
            <n-button
                    :loading = "loading"
                    @click="flushTable"
                    name="left-size"
                    type="info"
                    style="margin-bottom: 12px">
                刷新
            </n-button>
            <n-button
                    @click="showAddModal"
                    name="left-size"
                    type="info"
                    fixed="right"
                    style="margin-bottom: 12px">
                新增
            </n-button>
        </n-flex>
        <!--表格数据新增Modal-->
        <n-modal
                v-model:show="tableAddModal"
                preset="dialog"
                title="新增"
                :model="addingData"
        >
            <n-form :label-width="100"
                    label-placement="left"
            >
                <n-form-item label="项目名称" path="id">
                    <n-input v-model:value="addingData.name" placeholder="输入项目名称" />
                </n-form-item>
                <n-form-item label="匹配路径" path="originPath">
                    <n-input v-model:value="addingData.originPath" placeholder="输入项目地址" />
                </n-form-item>
                <n-form-item label="转发至路径" path="targetPath">
                    <n-input v-model:value="addingData.targetPath" placeholder="输入转发目的路径" />
                </n-form-item>
                <n-flex justify="end">
                    <n-button type="success" attr-type="button" @click="saveTableData(addingData)">
                        保存
                    </n-button>
                </n-flex>
            </n-form>
        </n-modal>
        <!-- 表格数据修改Modal-->
        <n-modal
                v-model:show="tableEditModal"
                preset="dialog"
                title="修改">
            <n-form :label-width="100"
                    label-placement="left"
                    :model="editingData"
            >
                <n-form-item label="项目名称" path="name">
                    <n-input v-model:value="editingData.name" placeholder="输入项目名称" />
                </n-form-item>
                <n-form-item label="匹配路径" path="originPath">
                    <n-input v-model:value="editingData.originPath" placeholder="输入项目地址" />
                </n-form-item>
                <n-form-item label="转发至路径" path="targetPath">
                    <n-input v-model:value="editingData.targetPath" placeholder="输入转发目的路径" />
                </n-form-item>
                <n-flex justify="flex-end">
                    <n-button type="success" attr-type="button" @click="saveTableData(editingData)">
                        保存
                    </n-button>
                </n-flex>
            </n-form>
        </n-modal>
        <!--表格-->
        <n-data-table
                :columns="columns"
                :data="tableData"
                :row-key="rowKey"
                default-expand-all
                style="text-align: center"
        />
    </n-config-provider>
</div>
</body>
<script>
    const { createApp, ref, h, defineComponent, reactive } = Vue;
    const { NInput, NButton, NTag, NIcon, createDiscreteApi, zhCN, dateZhCN } = naive;
    const { message } = createDiscreteApi(['message']);
    const { modal } = createDiscreteApi(['modal']);

    const tableColumns= [
        {
            title: '项目名称',
            key: 'name',
            minWidth: '80px',
        },
        {
            title: '项目源地址',
            key: 'originPath',
            minWidth: '120px'
        },
        {
            title: '项目转发地址',
            key: 'targetPath',
            minWidth: '120px'
        }
    ];

    const app = createApp({
        setup() {
            // 入口函数
            // 配和 <n-message-provider/> 标签使用
            // const message = useMessage();
            return {
                zhCN,
                dateZhCN,
                rowKey: (row) => row.id,
                loading: ref(false),
                tableData: ref([]),
                tableAddModal: ref(false),
                addingData: ref({}),
                tableEditModal: ref(false),
                editingData: ref({}),
            };
        },
        mounted() {
            window.onload = () => this.flushTable()
        },
        data() {
            return {
                columns: createColumns({
                    operation: {
                        edit: {
                            buttonSize: 'tiny',
                            buttonType: 'info',
                            buttonName: '修改',
                            func: (row) => {
                                this.editingData = row;
                                this.tableEditModal = true
                            }
                        },
                        remove: {
                            buttonSize: 'tiny',
                            buttonType: 'error',
                            buttonName: '删除',
                            func: (row) => {
                                this.removeTableData(row)
                            }
                        }
                    },
                    existedColumns: tableColumns
                }),
            }
        },
        methods: {
            flushTable() {
                this.loading = true;
                axios.get('/route/list')
                    .then(data => this.tableData = data.map(e => {
                        return {
                            name: e.id,
                            originPath: e.predicates[0].paths.join(","),
                            targetPath: e.uri
                        };
                    }))
                    .finally(() => this.loading = false);
            },
            showAddModal() {
                this.tableAddModal = true;
            },
            saveTableData(data) {
                let routeDe = {
                    id: data.name,
                    uri: data.targetPath,
                    predicates: [{
                        name: 'Path',
                        paths: [data.originPath]
                    }]
                }
                axios.post('/route/save', routeDe)
                    .then(() => {
                        this.tableAddModal &= false;
                        this.tableEditModal &= false;
                        message.success('用户保存成功');
                    })
            },
            removeTableData(data) {
                axios.post('/route/remove', data.id)
                    .then(() => {
                        this.flushTable();
                        message.success('删除用户成功');
                    });
            }
        }
    }).use(naive).mount('#app');
</script>
<style>
    body{
        padding: 10px;
    }
</style>
</html>